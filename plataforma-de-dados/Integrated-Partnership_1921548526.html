<!DOCTYPE html>
<html>
    <head>
        <title>Plataforma de Dados : Integrated Partnership</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Plataforma de Dados</a></span>
                            </li>
                                                    <li>
                                <span><a href="Plataforma-de-Dados_1898840277.html">Plataforma de Dados</a></span>
                            </li>
                                                    <li>
                                <span><a href="Datalake_1982726152.html">Datalake</a></span>
                            </li>
                                                    <li>
                                <span><a href="1900216592.html">Dicionário de dados</a></span>
                            </li>
                                                    <li>
                                <span><a href="Metabase_1900216909.html">Metabase</a></span>
                            </li>
                                                    <li>
                                <span><a href="Squad-Parceria_1921351705.html">Squad Parceria</a></span>
                            </li>
                                                    <li>
                                <span><a href="Parceria---Dashboards_1921908743.html">Parceria - Dashboards</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Plataforma de Dados : Integrated Partnership
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Alessandro Oliveira (Unlicensed)</span>, last modified on Mar 30, 2022
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><strong>Responsável</strong>: <a class="confluence-userlink user-mention" data-username="60ca0042b1f93b00691dabb9" data-account-id="60ca0042b1f93b00691dabb9" href="https://a55tech.atlassian.net/wiki/people/60ca0042b1f93b00691dabb9?ref=confluence" target="_blank" data-base-url="https://a55tech.atlassian.net/wiki">Karen Moraes (Unlicensed)</a> </p><p><strong>URL</strong>: <a class="external-link" href="https://metabase.a55.tech/dashboard/553-integrated-partnership?data_in%25C3%25ADcio=2021-10-01&amp;data_fim=2022-03-31" rel="nofollow">https://metabase.a55.tech/dashboard/553-integrated-partnership?data_in%C3%ADcio=2021-10-01&amp;data_fim=2022-03-31</a></p><hr/><p>Propósito: Este dashboard tem como objetivo fornecer uma visão detalhada acerca dos KPIs referentes aos canais de parceiras da a55.</p><p>As informações presentes no dashboard são:</p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1672335908036 {padding: 0px;}
div.rbtoc1672335908036 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1672335908036 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1672335908036'>
<ul class='toc-indentation'>
<li><a href='#IntegratedPartnership-PartnershipOverview'>Partnership Overview</a>
<ul class='toc-indentation'>
<li><a href='#IntegratedPartnership-TotalDeals'>Total Deals</a></li>
<li><a href='#IntegratedPartnership-GrossDisbursementPartnership'>Gross Disbursement Partnership</a></li>
<li><a href='#IntegratedPartnership-NetDisbursementPartnership'>Net Disbursement Partnership</a></li>
<li><a href='#IntegratedPartnership-Revenue(TACA55+TaxRevenue)'>Revenue (TAC A55 + Tax Revenue)</a></li>
<li><a href='#IntegratedPartnership-PartnershipConvertionFunnel'>Partnership Convertion Funnel</a></li>
</ul>
</li>
<li><a href='#IntegratedPartnership-Disbursement'>Disbursement</a>
<ul class='toc-indentation'>
<li><a href='#IntegratedPartnership-AverageTicketPartnership'>Average Ticket Partnership</a></li>
<li><a href='#IntegratedPartnership-TakeRatePartnership'>Take Rate Partnership</a></li>
<li><a href='#IntegratedPartnership-AverageMonthlyRate'>Average Monthly Rate</a></li>
<li><a href='#IntegratedPartnership-AverageCETRate'>Average CET Rate</a></li>
<li><a href='#IntegratedPartnership-DisbursementbyPartner'>Disbursement by Partner</a></li>
<li><a href='#IntegratedPartnership-AverageTicketbyPartner'>Average Ticket by Partner</a></li>
</ul>
</li>
<li><a href='#IntegratedPartnership-NPL'>NPL</a>
<ul class='toc-indentation'>
<li><a href='#IntegratedPartnership-ContractsinNPL(Current)'>Contracts in NPL (Current)</a></li>
<li><a href='#IntegratedPartnership-TotalAmountNPL(Current)'>Total Amount NPL (Current)</a></li>
<li><a href='#IntegratedPartnership-TotalContractsNPL(Current)'>Total Contracts NPL (Current)</a></li>
</ul>
</li>
<li><a href='#IntegratedPartnership-UpsellsxFirstDisbursement'>Upsells x First Disbursement</a>
<ul class='toc-indentation'>
<li><a href='#IntegratedPartnership-FirstDisbursement'>First Disbursement</a></li>
<li><a href='#IntegratedPartnership-GrossDisbursementFirstLoan'>Gross Disbursement First Loan</a></li>
<li><a href='#IntegratedPartnership-Upsells'>Upsells</a></li>
<li><a href='#IntegratedPartnership-GrossDisbursementUpsell'>Gross Disbursement Upsell</a></li>
<li><a href='#IntegratedPartnership-LeadTimePartnership'>Lead Time Partnership</a></li>
</ul>
</li>
</ul>
</div><h1 id="IntegratedPartnership-PartnershipOverview">Partnership Overview</h1><h2 id="IntegratedPartnership-TotalDeals">Total Deals</h2><p>A quantidade total de deals é definida como a quantidade distinta de registros presentes no HubSpot que possuem um parceiro como canal de origem.</p><div id="expander-1761360586" class="expand-container"><div id="expander-control-1761360586" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1761360586" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">select 
    count(distinct hubspot_export.hubspot_id) as deals
from datascience.dl_partner
join datascience.hubspot_export
    on hubspot_export.origination_partner = dl_partner.ds_partner
where 1 = 1 
    [[and {{ds_cost_center}}]]
    [[and {{partner}}]]
    [[and TO_TIMESTAMP(hubspot_export.create_date, &#39;YYYY-MM-DD HH24:MI:SS.US&#39;)   between {{dt_inicio}} and {{dt_fim}}]]</pre>
</div></div></div></div><h2 id="IntegratedPartnership-GrossDisbursementPartnership">Gross Disbursement Partnership</h2><p>O desembolso bruto é dado como a soma do valor ofertado ao cliente (principal), incluindo taxas e impostos associados. A definição de desembolso bruto pode ser encontrada em<a href="Desembolso-Bruto_1912537089.html" data-linked-resource-id="1912537089" data-linked-resource-version="8" data-linked-resource-type="page">Desembolso Bruto</a>.</p><p>O valor mostrado corresponde somente aos deals oriundos de parceiros, que por hora podem ser consultados na planilha <a class="external-link" href="https://docs.google.com/spreadsheets/d/1UCQePb7PdPSh1XJOW0_WFLSDWXAzsvsf12e0ZDhTHiU/edit?usp=sharing" rel="nofollow">Planilha de Parceiros</a>.</p><div id="expander-825014993" class="expand-container"><div id="expander-control-825014993" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-825014993" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">with disbursment_values as (	
	select 
		distinct i.id
			   , i.gross_amount
			   , i.liquid_amount 
			   , i.net_amount
			   , i.gross_amount - i.iof - i.fee_a55 - i.fee_issuer - i.&quot;fee_CETIP&quot; as calc_amount 
			   , i.iof
			   , i.fee_a55  
			   , i.fee_issuer			  
			   , i.&quot;fee_CETIP&quot; as fee_CETIP			   			   
	from asset.instrument i
	join asset.operation o 
		on i.operation_id = o.id
	left join asset.realized_cashflow_entry rce
		on i.id = rce.instrument_id
	join asset.cashflow_type ct 
		on ct.id = rce.cashflow_type_id 
	left join asset.instrument_related irD
		on i.id = irD.destination_instrument
	left join datascience.dl_user_origination duo 
        on duo.nu_cnpj = o.client_id
    left join datascience.dl_partner           
        on dl_partner.ds_partner = duo.ds_origination_partner
	where 1=1	    
		and irD.origin_instrument is null -- retirando contratos renegociados 
		[[and i.loan_date between {{dt_inicio}} and {{dt_fim}}]]
		[[and {{cost_center}}]]
		[[and {{partner}}]]
)
select sum(gross_amount::float)/100
from disbursment_values 
</pre>
</div></div></div></div><p /><h2 id="IntegratedPartnership-NetDisbursementPartnership">Net Disbursement Partnership</h2><p>O desembolso líquido corresponde ao valor bruto descontado de taxas e impostos. Trata-se do valor efetivo que o cliente recebe. </p><p>A definição de desembolso líquido pode ser encontrada em <a href="1912569896.html" data-linked-resource-id="1912569896" data-linked-resource-version="8" data-linked-resource-type="page">Desembolso Líquido</a>.</p><p>O valor mostrado corresponde somente aos deals oriundos de parceiros, que por hora podem ser consultados na planilha <a class="external-link" href="https://docs.google.com/spreadsheets/d/1UCQePb7PdPSh1XJOW0_WFLSDWXAzsvsf12e0ZDhTHiU/edit?usp=sharing" rel="nofollow">Planilha de Parceiros</a>.</p><div id="expander-612991267" class="expand-container"><div id="expander-control-612991267" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-612991267" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">with disbursment_values as (	
	select 
		distinct i.id
			   , i.gross_amount
			   , i.liquid_amount 
			   , i.net_amount
			   , i.gross_amount - i.iof - i.fee_a55 - i.fee_issuer - i.&quot;fee_CETIP&quot; - i.commission as calc_amount
			   , i.iof
			   , i.fee_a55  
			   , i.fee_issuer			  
			   , i.&quot;fee_CETIP&quot; as fee_CETIP			   			   
	from asset.instrument i
	join asset.operation o 
		on i.operation_id = o.id
	left join asset.realized_cashflow_entry rce
		on i.id = rce.instrument_id
	join asset.cashflow_type ct 
		on ct.id = rce.cashflow_type_id 
	left join asset.instrument_related irD
		on i.id = irD.destination_instrument
	left join datascience.dl_user_origination duo 
        on duo.nu_cnpj = o.client_id
    left join datascience.dl_partner           
        on dl_partner.ds_partner = duo.ds_origination_partner
	where 1=1	    
		and irD.origin_instrument is null -- retirando contratos renegociados 
		[[and loan_date between {{dt_inicio}} and {{dt_fim}}]]
		[[and {{cost_center}}]]
		[[and {{partner}}]]
		--and i.id = 1365		
		--and i.id = 2447
)
select sum(net_amount::float)/100
from disbursment_values 
</pre>
</div></div></div></div><h2 id="IntegratedPartnership-Revenue(TACA55+TaxRevenue)">Revenue (TAC A55 + Tax Revenue)</h2><p>A receita corresponde a diferença entre o valor bruto do contrato (<a href="Desembolso-Bruto_1912537089.html" data-linked-resource-id="1912537089" data-linked-resource-version="8" data-linked-resource-type="page">Desembolso Bruto</a>), e o valor efetivo a ser pago somando todas as parcelas do contrato, aplicadas as taxas de juros pertinentes. </p><div id="expander-1640445011" class="expand-container"><div id="expander-control-1640445011" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1640445011" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">with fee_a55 as (
		 with faturamento_realizado as (
			select
				realized.id as realized_id,
				instrument.id as instrument_id, 
			    loan_date::date,
			    client.name,
			    client.cnpj,
			    issuer.name as issuer_name,
			    -sum(realized.amount::float/100) amount_bruto,
			    sum((instrument.fee_issuer::float + instrument.&quot;fee_CETIP&quot;::float + instrument.fee_a55::float) /100) as tac_total,
			    sum(instrument.iof::float/100) as iof
			from asset.realized_cashflow_entry realized
			    left join asset.instrument instrument 	
			        on instrument.id = realized.instrument_id
			    left join asset.operation operation 	
			        on operation.id = instrument.operation_id 
			    left join asset.client client 			
			        on client.cnpj = operation.client_id
			    left join asset.issuer 					
			        on issuer.id = instrument.issuer_id 
			    left join datascience.dl_user_origination 
			        on operation.client_id = dl_user_origination.nu_cnpj
			    left join datascience.dl_partner
			        on dl_partner. ds_partner = dl_user_origination.ds_origination_partner
			where realized.cashflow_type_id = 1
			    [[and instrument.loan_date::date between {{dt_inicio}} and {{dt_fim}}]]
			    [[and {{partner}}]]
			    [[and {{costcenter}}]]
			    and instrument.id not in 
			(
			    select -- empresas que possuem renegociação
			        related.destination_instrument
			    from asset.instrument_related related
			)  
			group by realized.id, realized.expected_cashflow_id, loan_date::date, instrument.id , client.name, client.cnpj, issuer.name
			order by loan_date::date
		)
		, amount_issuer as (
			select
				date_trunc(&#39;month&#39;, instrument.loan_date)::date as periodo,
			    issuer.name as issuer_name,
			    -sum(realized.amount::float/100) amount_total_issuer
			from asset.instrument instrument 
			    join asset.operation operation 	
			    	on operation.id = instrument.operation_id 
			    left join asset.realized_cashflow_entry realized
			    	on instrument.id = realized.instrument_id
			    left join asset.issuer 					
			    	on issuer.id = instrument.issuer_id
			    left join datascience.dl_user_origination 
			        on operation.client_id = dl_user_origination.nu_cnpj 
			    left join datascience.dl_partner
			        on dl_partner. ds_partner = dl_user_origination.ds_origination_partner
			where realized.cashflow_type_id = 1
			    [[and instrument.loan_date::date between {{dt_inicio}} and {{dt_fim}}]]
			    [[and {{partner}}]]
			    and instrument.id not in 
			(
			    select -- empresas que possuem renegociação
			        related.destination_instrument
			    from asset.instrument_related related
			)  
			group by 
				date_trunc(&#39;month&#39;, instrument.loan_date)::date,
			    issuer.name
			order by date_trunc(&#39;month&#39;, instrument.loan_date)::date
			)
		, custo_por_issuer as (
			select 
				fr.name as empresa,
			    fr.cnpj,
			    fr.instrument_id,
			    fr.loan_date,
			    fr.issuer_name as bancarizador,
			    fr.tac_total,
			    fr.iof,
			    amount_bruto,
				amount_bruto - (tac_total + iof) as amount_liquido,
				case 
					when fr.issuer_name = &#39;MoneyPlus&#39; 
						then (amount_bruto - (tac_total + iof))*0.0035
					when fr.issuer_name = &#39;QI Tech&#39; 
						and amount_total_issuer &lt;= 1000000
						then (amount_bruto*0.0045)
					when fr.issuer_name = &#39;Socinal&#39; 
						and amount_total_issuer &lt;= 2500000 
						then (((tac_total - (amount_bruto*0.0080))*0.0965) + (amount_bruto*0.0080)) -- tac total menos o custo do bancarizador menos o imposto que é pago pro governo 
					when fr.issuer_name = &#39;Socinal&#39; 
						and amount_total_issuer between 2500000.01 and 5000000 
						then (((tac_total - (amount_bruto*0.0070))*0.0965) + (amount_bruto*0.0070))
					when fr.issuer_name = &#39;Socinal&#39; 
						and amount_total_issuer between 5000000.01 and 7500000 
						then (((tac_total - (amount_bruto*0.0060))*0.0965) + (amount_bruto*0.0060))
				end as custo
			from faturamento_realizado fr
			left join amount_issuer ai
				on date_trunc(&#39;month&#39;, fr.loan_date) = ai.periodo
				and fr.issuer_name = ai.issuer_name
		)
		select
		    sum(case when tac_total &gt; 0 
			    then (tac_total - custo)
			    else 0
		    end) as tac_a55    
		from custo_por_issuer
)
, tax_renevue as (
		with renegociacoes as (

			select distinct i.id 
			from asset.instrument i 	
			where 1=1
				and i.contract_number like (&#39;%(2)%&#39;)
				
		)
		, base as (
		
		select distinct
			   o.operation_code 			as cod_operacao			 
			 , is2.status					as st_instrumento 
			 , os.status 					as st_operacao
			 , i.loan_date 					as dt_desembolso
			 , i.net_amount/100	 		 	as vl_desembolso	 
			 , ece.amount/100 				as vl_parcela	 
			 , ece.principal/100			as vl_principal	 	 	 
			 , c.cnpj 		     		 	as nu_cnpj_empresa     
		     , ece.date 					as dt_vencimento_parcela          
		     , ece.status_id     
		     , case 
		     		when rce.date is not null then 1 else 0 
		     		end as fl_pago_reneg               
		     , case 
		     		when ece.status_id = 2 and ece.&quot;date&quot; &lt; current_date - 1 then 1 else 0 
		     		end as fl_pago_parcelas_nao_expiradas   	 
		     , rce.amount/100 as vl_pago_parcela_original
		   	 , case when rce.amount/100 in (1,0) then null
		   	 		when irO.destination_instrument is not null and rce.amount &gt; i.net_amount*0.8 then null
		   	 		else rce.amount/100   	 		
		   	 		end as vl_pago_parcela
		   	 , rce.date as dt_vencimento_original
		   	 , case when rce.amount/100 in (1,0) then null 
		   	 		when irO.destination_instrument is not null and rce.amount/100 &gt; 1 then null
		   	 		else rce.date 
		   	 		end as dt_pagamento_parcela
		   	 , cast(ece.date as date) as dt_vencimento
		   	 , case when cast(coalesce(irO.related_date,irD.related_date) as date) &gt;= ece.date and i.contract_number like &#39;%(2)%&#39; then ece.date 
		     		else cast(coalesce(irO.related_date,irD.related_date) as date) end as dt_contrato_relacionado     
		   	 , cs.status 
		     , case when (case   
			     		-- Se a data de hoje é menor que o &#39;expected&#39; ou a data de renegociacao é menor que o &#39;expected&#39; logo, não tem atraso
			     		when current_date - 1 &lt;= rce.&quot;date&quot; or rce.&quot;date&quot; &lt;= cast(coalesce(irO.related_date,irD.related_date) as date) then 0  
			     		-- Se a data da renegociação não é nula e está ENTRE a data da parcela , e a data da parcela + 30 , então considera só a diferença da reneg com a expected
			     		when cast(coalesce(irO.related_date,irD.related_date) as date) is not null and irD.origin_instrument is null and rce.&quot;date&quot; is null then cast(coalesce(irO.related_date,irD.related_date) as date) - ece.date
			     		-- Se não data de hoje ou &#39;realized&#39; - &#39;expected&#39;
			     	 else coalesce(rce.&quot;date&quot;, current_date - 1) - ece.date
			     		end) &lt; 0 then 0 else (case   
			     		-- Se a data de hoje é menor que o &#39;expected&#39; ou a data de renegociacao é menor que o &#39;expected&#39; logo, não tem atraso
			     		when current_date - 1 &lt;= rce.&quot;date&quot; or rce.&quot;date&quot; &lt;= cast(coalesce(irO.related_date,irD.related_date) as date) then 0  
			     		-- Se a data da renegociação não é nula e está ENTRE a data da parcela , e a data da parcela + 30 , então considera só a diferença da reneg com a expected
			     		when cast(coalesce(irO.related_date,irD.related_date) as date) is not null and irD.origin_instrument is null and rce.&quot;date&quot; is null then cast(coalesce(irO.related_date,irD.related_date) as date) - ece.date
			     		-- Se não data de hoje ou &#39;realized&#39; - &#39;expected&#39;
			     		else coalesce(rce.&quot;date&quot;, current_date - 1) - ece.date
			     		end) 
			     	 end as nu_dias_atraso
		     , case when (case 
		     				when current_date - 1 &lt;= ece.&quot;date&quot; or cast(irO.related_date as date) &lt;= ece.date 
				     		then 0  
				     		else coalesce(rce.&quot;date&quot;, current_date - 1) - ece.date
				     		end
				     	  ) &lt; 5 and 
				     	  (case 
				     	  	when ece.date &gt; current_date - 1 
				     	  	then 0 
				     	  	else 1 
				     	  	end
				     	   ) = 1 then 1
				     	   else 0 end as fl_pago_em_dia		     	          
		     , case 
		     		when ece.date &gt; current_date - 1 then 0 else 1  -- Trazer apenas datas expiradas de parcelas validas
		       end fl_expirada
		     , case 
		     		when ece.status_id = 2 and rce.amount &gt; 1 then 1 else 0 
		       end as fl_pago
		     , case when irO.destination_instrument is null and irD.origin_instrument is not null then 1 else 0 end fl_renegociacao
		     , i.id				 		 	as id_contrato     
		     , i.contract_number   
		     , case 
		     		when cast(coalesce(irO.related_date,irD.related_date) as date) is null then 1
		     		when 
		     			 ((cast(ece.date as date) &lt;= case when cast(coalesce(irO.related_date,irD.related_date) as date) &gt;= ece.date and i.contract_number like &#39;%(2)%&#39; then ece.date 
		     		else cast(coalesce(irO.related_date,irD.related_date) as date) end) and irD.origin_instrument is null) or 
		     			 ((cast(ece.date as date) &gt;= case when cast(coalesce(irO.related_date,irD.related_date) as date) &gt;= ece.date and i.contract_number like &#39;%(2)%&#39; then ece.date 
		     		else cast(coalesce(irO.related_date,irD.related_date) as date) end) and irO.destination_instrument is null)
		     		then 1 else 0 end as fl_parcela_valida
		     , case when cast(irD.related_date as date) is not null
		     		then 1 
		     		else 0 end fl_parcela_pos_reneg
		     , case when ece.status_id = 3 then 1 else 0 end as fl_parcela_pre_renegoc_status
		     , case when i.contract_number like &#39;%(1)%&#39; then 1
		     		when i.contract_number like &#39;%(2)%&#39; then 2
		     		when i.contract_number like &#39;%(3)%&#39; then 3
		     		when i.contract_number like &#39;%(4)%&#39; then 4
		     		when i.contract_number like &#39;%(5)%&#39; then 5
		     		else 1
		     		end as nu_reneg
		from asset.client c 
		inner join asset.operation o 
		        on 1=1
		        and c.cnpj = o.client_id 
		inner join asset.operation_type ot 
		        on 1=1
		        and ot.id = o.operation_type_id 
		inner join asset.instrument i
		        on 1=1
		        and i.operation_id = o.id
		inner join asset.vehicle v 
		        on 1=1
		        and v.id = i.vehicle_id
		inner join asset.expected_cashflow_entry ece
		    	on 1=1
		    	and ece.instrument_id = i.id  
		left join asset.realized_cashflow_entry rce 
		 		on 1=1
		 		and ece.id = rce.expected_cashflow_id 
		left join asset.operation_status os 
				on 1=1
				and os.id = o.status_id 
		left join asset.instrument_status is2 
				on 1=1
				and is2.id = i.status_id 
		left join asset.cashflow_status cs
				on 1=1
				and cs.id = ece.status_id 
		left join asset.instrument_related irD
				on 1=1
				and i.id = irD.destination_instrument 		
		left join asset.instrument_related irO
				on 1=1
				and i.id = irO.origin_instrument
		left join datascience.dl_user_origination
		    on o.client_id = dl_user_origination.nu_cnpj 
	    left join datascience.dl_partner
	        on dl_partner. ds_partner = dl_user_origination.ds_origination_partner
		where 1=1
		     and o.status_id in (3 , 5)
		     and ece.status_id &gt; 0     
		     and o.operation_type_id = 5
		     [[and i.loan_date between {{dt_inicio}} and {{dt_fim}}]]
		     [[and {{partner}}]]
		     [[and {{costcenter}}]]
		     --and o.operation_code = &#39;ARAZUL DIGITAL&#39;
		 order by 	
		 	   contract_number
		 	 , i.loan_date  	 
		 	 , ece.date    
		  
		), sumarizacao as (
		
		select 
			 id_contrato 
		   , aux.gross_amount 
		   , sum(vl_parcela) as vl_divida
		   , sum(vl_parcela)::float - aux.gross_amount::float as receita_juros 
		from base b
		left join 
			(
				select id, gross_amount/100 as gross_amount from asset.instrument where 1=1
			) aux
		on 1=1
		and b.id_contrato::int = aux.id::int
		where 1=1 
			and fl_renegociacao = 0
			and fl_expirada = 0
		group by 
			  id_contrato 
			, aux.gross_amount 
		
		)
		
		select sum(receita_juros) as receita_juros 
		from sumarizacao 
)
, revenue as (
    select receita_juros from tax_renevue union all 
    select tac_a55 from fee_a55
)
select sum (receita_juros) from revenue </pre>
</div></div></div></div><h2 id="IntegratedPartnership-PartnershipConvertionFunnel">Partnership Convertion Funnel</h2><p>Este funil tem por objetivo mostrar a quantidade de empresas que atravessam todas as etapas do fluxo de negócio da a55. O topo do funil corresponde a todas as empresas via parceria que chegam para a a55, enquanto que o bico corresponde as empresas que desembolsam mais de uma linha de crédito.</p><p>O funil é divido em quatro etapas:</p><ol><li><p>Todas as empresas que chegam via parceria possuem uma maior automatização quanto ao recebimento de seus dados e extratos. Porém, nem toda empresa consegue efetivamente receber uma proposta da a55. Em geral trata-se do maior afunilamento.</p></li><li><p>Após recebido a proposta, a empresa possui a opção de aceitar ou não o valor e as condições ofertadas pela a55.</p></li><li><p>Após aceita a proposta, o desembolso corresponde ao momento exato em que o cliente passa a ter acesso ao crédito. Trata-se da região com menor afunilamento.</p></li><li><p>Após recebido o desembolso, muitas vezes o cliente tem interesse numa nova linha de crédito. Caso receba e aceite uma nova linha, passa-se a ser um cliente upsell.</p></li></ol><div id="expander-1798933286" class="expand-container"><div id="expander-control-1798933286" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1798933286" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">with deals as (
	select 
		TO_TIMESTAMP(hed.create_date, &#39;YYYY-MM-DD HH24:MI:SS.US&#39;)::date create_date,
		TO_TIMESTAMP(hed.close_date , &#39;YYYY-MM-DD HH24:MI:SS.US&#39;)::date close_date,
		hed.origination_partner, 
		hubspot_id, 
		hed.cnpj, 
		-- transformar o campo stage_id de texto para inteiro 
		case 
			when deal_stage_id = &#39;&#39; then null 
				else deal_stage_id::int
		end as deal_stage_id, 
		dl_partner.ds_cost_center, 
		dl_partner.ds_partner
	from datascience.hubspot_export hed 
	join datascience.dl_partner
		on dl_partner.ds_partner = hed.origination_partner 
	where 1 = 1
	    [[and {{ds_cost_center}}]]
	    [[and {{partner}}]]
	    [[and TO_TIMESTAMP(hed.create_date, &#39;YYYY-MM-DD HH24:MI:SS.US&#39;)::date between {{inicio}} and {{fim}}]]
) 
, deal_proposal as (
-- como não existe uma relação unica por cnpj entre solicitação de uma linha de credito &gt; proposta aprovada/aceita &gt; desembolso
-- parti da premissa de que um deal de parceria so pode solicitar uma nova linha de crédito caso ele não tenha nenhuma outra solicitação em andamento
-- dessa forma, crio a relação unica por um ranqueamento de datas, unindo uma proposta aprovada/aceita à data de criação mais proxima do deal  
	select
		row_number() over(partition by proposals.id  order by (proposals.created_at - create_date) asc) as rn, 
		proposals.created_at - create_date as lead_time, 
		deals.hubspot_id,
		deals.cnpj,
		proposals.id as proposal_id,
		proposals.status,
		case 
			when proposals.status = &#39;accepted&#39; 
				then proposals.id else null
		end as accepted_proposal
	from deals
	join proposals.proposals
		on proposals.cnpj = deals.cnpj
	where proposals.created_at &gt;= create_date
) 
, deal_disbursement as (
	select
		row_number() over(partition by i.id order by (loan_date - create_date) asc) as rn, 
		loan_date - create_date as lead_time, 
		o.client_id,
		deals.hubspot_id, 
		i.id as instrument_id,
		case 
			when substring(operation_code, LENGTH(operation_code) - 1) not like &#39;\d&#39; 
			then contract_number
			else null 
		end as first_disbursement,
		case 
			when substring(operation_code, LENGTH(operation_code) - 1) ~ &#39;\d&#39; 
			then contract_number
			else null
		end as upsell,
		i.loan_date  
	from asset.instrument i
	join asset.operation o 
		on i.operation_id = o.id 
	join deals
		on o.client_id = deals.cnpj
		and i.loan_date &gt;= deals.create_date -- a linha de crédito só pode ter sido realizada após a entrada do deal
	join datascience.dl_partner
		on dl_partner.ds_partner = deals.ds_partner 
	where 1 = 1 
		[[and {{ds_cost_center}}]]
		[[and {{partner}}]]
		[[and deals.create_date between {{inicio}} and {{fim}}]]
)
, final as (
    select
    	count(distinct deals.hubspot_id) as deals,
    	count(distinct proposal_id) as genereted_proposals,
    	count(distinct accepted_proposal) as accepted_proposals,
    	count(distinct deal_disbursement.first_disbursement) as disbursement,
    	count(distinct deal_disbursement.upsell) as upsell
    from deals
    left join deal_proposal
    	on deals.hubspot_id = deal_proposal.hubspot_id 
    	and deal_proposal.rn = 1
    left join deal_disbursement 
    	on deals.hubspot_id = deal_disbursement.hubspot_id  
    	and deal_disbursement.rn = 1
)
select deals, &#39;Deals&#39; as step from final union all 
select genereted_proposals, &#39;Genereted Proposal&#39; as step  from final union all 
select accepted_proposals, &#39;Accepted Proposal&#39; as step from final union all 
select disbursement, &#39;Disbursment&#39; as step from final union all 
select upsell, &#39;Upsell&#39; as step from final</pre>
</div></div></div></div><h1 id="IntegratedPartnership-Disbursement">Disbursement</h1><h2 id="IntegratedPartnership-AverageTicketPartnership">Average Ticket Partnership</h2><p>O valor do ticket médio corresponde a soma do valor bruto (<a href="Desembolso-Bruto_1912537089.html" data-linked-resource-id="1912537089" data-linked-resource-version="8" data-linked-resource-type="page">Desembolso Bruto</a>)  de cada contrato, divido pela quantidade de contratos oriundos de parceria.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/1921548526/1921613848.png" data-image-src="attachments/1921548526/1921613848.png" data-height="41" data-width="356" data-unresolved-comment-count="0" data-linked-resource-id="1921613848" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20220329-221047.png" data-base-url="https://a55tech.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1921548526" data-linked-resource-container-version="16" data-media-id="3e880547-80f2-4a03-b1d4-afd5d8baddf5" data-media-type="file"></span><div id="expander-1893138090" class="expand-container"><div id="expander-control-1893138090" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1893138090" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">select 
	sum(gross_amount::float)/100 /
	count(distinct instrument.id ) as ticket_medio
from asset.instrument 
left join asset.operation 
    on operation.id = instrument.operation_id
left join datascience.hubspot_export
	on hubspot_export.cnpj = operation.client_id
left join datascience.dl_user_origination duo 
    on duo.nu_cnpj = operation.client_id
left join datascience.dl_partner           
    on dl_partner.ds_partner = duo.ds_origination_partner
where 1 = 1
	[[and loan_date between {{dt_inicio}} and {{dt_fim}}]]
	[[and {{ds_cost_center}}]]
	[[and {{partner}}]]
	and hubspot_export.origination_partner is not null 
	and hubspot_export.origination_partner &lt;&gt; &#39;&#39;</pre>
</div></div></div></div><h2 id="IntegratedPartnership-TakeRatePartnership">Take Rate Partnership</h2><p>Para cada contrato, take rate (TR) é definido como a subtração da TAC A55 pela quantia paga ao parceiro oriundo do contrato (<a href="1907654657.html" data-linked-resource-id="1907654657" data-linked-resource-version="4" data-linked-resource-type="page">Relatório de Intermediação</a>) :</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/1921548526/1922596908.png" data-image-src="attachments/1921548526/1922596908.png" data-height="13" data-width="239" data-unresolved-comment-count="0" data-linked-resource-id="1922596908" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20220330-143402.png" data-base-url="https://a55tech.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1921548526" data-linked-resource-container-version="16" data-media-id="0cf4dc4f-8b6c-4373-bb0f-c2d4e7d250b2" data-media-type="file"></span><p>O valor mostrado é a soma de todos os TR de cada contrato oriundo de parcerias.</p><div id="expander-739379820" class="expand-container"><div id="expander-control-739379820" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-739379820" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">with faturamento_realizado as (
	select
		realized.id as realized_id,
		instrument.id as instrument_id, 
	    loan_date::date,
	    client.name,
	    client.cnpj,
	    issuer.name as issuer_name,
	    -sum(realized.amount::float/100) amount_bruto,
	    sum((instrument.fee_issuer::float + instrument.&quot;fee_CETIP&quot;::float + instrument.fee_a55::float) /100) as tac_total,
	    sum(instrument.iof::float/100) as iof
	from asset.realized_cashflow_entry realized
	    left join asset.instrument instrument 	on instrument.id = realized.instrument_id
	    left join asset.operation operation 	on operation.id = instrument.operation_id 
	    left join asset.client client 			on client.cnpj = operation.client_id
	    left join asset.issuer 					on issuer.id = instrument.issuer_id 
	where realized.cashflow_type_id = 1
	    [[and instrument.loan_date::date between {{inicio}} and {{fim}}]]
	    and instrument.id not in 
	(
	    select -- empresas que possuem renegociação
	        related.destination_instrument
	    from asset.instrument_related related
	)  
	group by realized.id, realized.expected_cashflow_id, loan_date::date, instrument.id , client.name, client.cnpj, issuer.name
	order by loan_date::date
)
, amount_issuer as (
	select
		date_trunc(&#39;month&#39;, instrument.loan_date)::date as periodo,
	    issuer.name as issuer_name,
	    -sum(realized.amount::float/100) amount_total_issuer
	from asset.instrument instrument 
	    join asset.operation operation 	
	    	on operation.id = instrument.operation_id 
	    left join asset.realized_cashflow_entry realized
	    	on instrument.id = realized.instrument_id
	    left join asset.issuer 					
	    	on issuer.id = instrument.issuer_id 
	where realized.cashflow_type_id = 1
	    [[and instrument.loan_date::date between {{inicio}} and {{fim}}]]
	    and instrument.id not in 
	(
	    select -- empresas que possuem renegociação
	        related.destination_instrument
	    from asset.instrument_related related
	)  
	group by 
		date_trunc(&#39;month&#39;, instrument.loan_date)::date,
	    issuer.name
	order by date_trunc(&#39;month&#39;, instrument.loan_date)::date
	)
, custo_por_issuer as (
	select 
		fr.name as empresa,
	    fr.cnpj,
	    fr.instrument_id,
	    fr.loan_date,
	    fr.issuer_name as bancarizador,
	    fr.tac_total,
	    fr.iof,
	    amount_bruto,
		amount_bruto - (tac_total + iof) as amount_liquido,
		case 
			when fr.issuer_name = &#39;MoneyPlus&#39; 
				then (amount_bruto - (tac_total + iof))*0.0035
			when fr.issuer_name = &#39;QI Tech&#39; 
				and amount_total_issuer &lt;= 1000000
				then (amount_bruto*0.0045)
			when fr.issuer_name = &#39;Socinal&#39; 
				and amount_total_issuer &lt;= 2500000 
				then (((tac_total - (amount_bruto*0.0080))*0.0965) + (amount_bruto*0.0080)) -- tac total menos o custo do bancarizador menos o imposto que é pago pro governo 
			when fr.issuer_name = &#39;Socinal&#39; 
				and amount_total_issuer between 2500000.01 and 5000000 
				then (((tac_total - (amount_bruto*0.0070))*0.0965) + (amount_bruto*0.0070))
			when fr.issuer_name = &#39;Socinal&#39; 
				and amount_total_issuer between 5000000.01 and 7500000 
				then (((tac_total - (amount_bruto*0.0060))*0.0965) + (amount_bruto*0.0060))
		end as custo
	from faturamento_realizado fr
	left join amount_issuer ai
		on date_trunc(&#39;month&#39;, fr.loan_date) = ai.periodo
		and fr.issuer_name = ai.issuer_name
)
select 
	sum (
--		take_rate = tac da a55 - fee do parceiro
	    case when tac_total &gt; 0 
		    then (tac_total - custo)
		    else 0
	    end -
	    case 
	        when dl_partner.ds_partner = &#39;Harpia Investimentos&#39;
	        	then tac_total::float * dl_partner.pc_partner_fee::float
	        	else amount_liquido * dl_partner.pc_partner_fee::float
	    end) as take_rate
from custo_por_issuer
left join datascience.dl_user_origination duo
    on duo.nu_cnpj = custo_por_issuer.cnpj
inner join datascience.dl_partner
    on dl_partner.ds_partner = duo.ds_origination_partner
where 1 = 1 
    [[and {{cost_center}}]]
    [[and {{partner}}]]</pre>
</div></div></div></div><h2 id="IntegratedPartnership-AverageMonthlyRate">Average Monthly Rate</h2><p>A taxa média de juros mensal corresponde a média da taxa de juros aplicada no valor líquido de cada contrato oriundo de parceiras.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/1921548526/1922564152.png" data-image-src="attachments/1921548526/1922564152.png" data-height="41" data-width="484" data-unresolved-comment-count="0" data-linked-resource-id="1922564152" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20220329-221450.png" data-base-url="https://a55tech.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1921548526" data-linked-resource-container-version="16" data-media-id="babb0677-1140-42b7-acd5-765eaf27dd4d" data-media-type="file"></span><p /><div id="expander-22106638" class="expand-container"><div id="expander-control-22106638" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL </span></div><div id="expander-content-22106638" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">with disbursment_values as (	
	select 
		distinct i.id
			   , i.gross_amount
			   , i.liquid_amount 
			   , i.net_amount
			   , i.gross_amount - i.iof - i.fee_a55 - i.fee_issuer - i.&quot;fee_CETIP&quot; as calc_amount
			   , i.iof
			   , i.fee_a55  
			   , i.fee_issuer			  
			   , i.&quot;fee_CETIP&quot; as fee_CETIP
			   , i.net_monthly_rate
	from asset.instrument i
	join asset.operation o 
		on i.operation_id = o.id
	left join asset.realized_cashflow_entry rce
		on i.id = rce.instrument_id
	join asset.cashflow_type ct 
		on ct.id = rce.cashflow_type_id 
	left join asset.instrument_related irD
		on i.id = irD.destination_instrument
	left join datascience.dl_user_origination duo 
        on duo.nu_cnpj = o.client_id
    left join datascience.dl_partner           
        on dl_partner.ds_partner = duo.ds_origination_partner
	where 1=1	    
		and irD.origin_instrument is null -- retirando contratos renegociados 
		[[and i.loan_date between {{dt_inicio}} and {{dt_fim}}]]
		[[and {{cost_center}}]]
		[[and {{partner}}]]
)
select (sum(net_monthly_rate)/count(id))/100
from disbursment_values 
</pre>
</div></div></div></div><h2 id="IntegratedPartnership-AverageCETRate">Average CET Rate</h2><p>A taxa média de juros mensal corresponde a média da taxa de juros aplicada no valor bruto de cada contrato oriundo de parceiras.</p><div id="expander-1466996921" class="expand-container"><div id="expander-control-1466996921" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1466996921" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">with disbursment_values as (	
	select 
		distinct i.id
			   , i.gross_amount
			   , i.liquid_amount 
			   , i.net_amount
			   , i.gross_amount - i.iof - i.fee_a55 - i.fee_issuer - i.&quot;fee_CETIP&quot; as calc_amount
			   , i.iof
			   , i.fee_a55  
			   , i.fee_issuer			  
			   , i.&quot;fee_CETIP&quot; as fee_CETIP
			   , i.gross_monthly_rate
	from asset.instrument i
	join asset.operation o 
		on i.operation_id = o.id
	left join asset.realized_cashflow_entry rce
		on i.id = rce.instrument_id
	join asset.cashflow_type ct 
		on ct.id = rce.cashflow_type_id 
	left join asset.instrument_related irD
		on i.id = irD.destination_instrument
	left join datascience.dl_user_origination duo 
        on duo.nu_cnpj = o.client_id
    left join datascience.dl_partner           
        on dl_partner.ds_partner = duo.ds_origination_partner
	where 1=1	    
		and irD.origin_instrument is null -- retirando contratos renegociados 
		[[and i.loan_date between {{dt_inicio}} and {{dt_fim}}]]
		[[and {{cost_center}}]]
		[[and {{partner}}]]
)
select (sum(gross_monthly_rate)/count(id))/100
from disbursment_values 
</pre>
</div></div></div></div><h2 id="IntegratedPartnership-DisbursementbyPartner">Disbursement by Partner</h2><p>Este gráfico mostra concomitantemente a quantidade de empréstimos que cada parceiro originou, assim como a soma do valor bruto total dos empréstimos.</p><div id="expander-1971933952" class="expand-container"><div id="expander-control-1971933952" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1971933952" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">select 
	duo.ds_origination_partner,
	count(distinct instrument),
	sum(gross_amount::float)/100 as gross_amount 
from asset.instrument 
left join asset.operation 
    on operation.id = instrument.operation_id
left join datascience.dl_user_origination duo 
    on duo.nu_cnpj = operation.client_id
left join datascience.dl_partner           
    on dl_partner.ds_partner = duo.ds_origination_partner
where 1 = 1
	[[and loan_date between {{dt_inicio}} and {{dt_fim}}]]
	[[and {{ds_cost_center}}]]
	and duo.ds_origination_partner is not null 
	and duo.ds_origination_partner &lt;&gt; &#39;&#39;
group by 
    duo.ds_origination_partner
order by ds_origination_partner desc </pre>
</div></div></div></div><h2 id="IntegratedPartnership-AverageTicketbyPartner">Average Ticket by Partner</h2><p>Este gráfico mostra o valor médio do ticket dos contratos oriundos de cada parceiro, conforme definição em <a href="1922760707.html" data-linked-resource-id="1922760707" data-linked-resource-version="6" data-linked-resource-type="page">Ticket médio</a>.</p><h1 id="IntegratedPartnership-NPL">NPL</h1><h2 id="IntegratedPartnership-ContractsinNPL(Current)">Contracts in NPL (Current)</h2><p>Este gráfico monstra concomitantemente a quantidade de contratos em NPL (<a href="1903722523.html" data-linked-resource-id="1903722523" data-linked-resource-version="11" data-linked-resource-type="page">Non Performing Loan (NPL)</a>) oriundos de cada parceiro, assim como o valor aberto total de tais contratos.</p><div id="expander-1913593233" class="expand-container"><div id="expander-control-1913593233" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1913593233" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">select 
    ds_partner,
	count(distinct i.contract_number) as contracts,
	sum(ece.amount::float/100) as open_amount
from asset.expected_cashflow_entry ece 
join asset.instrument i 
	on i.id = ece.instrument_id 
join asset.operation o 
	on o.id = ece.operation_id 
join asset.operation_type ot 
	on o.operation_type_id = ot.id 
left join datascience.dl_user_origination duo 
    on duo.nu_cnpj = o.client_id
left join datascience.dl_partner           
    on dl_partner.ds_partner = duo.ds_origination_partner
where ece.status_id = &#39;1&#39;
    and (current_date - ece.date::date) &gt;= 90 
    [[and {{cost_center}}]]
group by ds_partner
ORDER By contracts</pre>
</div></div></div></div><h2 id="IntegratedPartnership-TotalAmountNPL(Current)">Total Amount NPL (Current)</h2><p>Trata-se do valor total dos contratos em NPL (<a href="1903722523.html" data-linked-resource-id="1903722523" data-linked-resource-version="11" data-linked-resource-type="page">Non Performing Loan (NPL)</a>) .</p><div id="expander-1605448934" class="expand-container"><div id="expander-control-1605448934" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1605448934" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">select
	sum(ece.amount::float)/100 as open_amount
from asset.expected_cashflow_entry ece 
join asset.instrument i 
	on i.id = ece.instrument_id 
join asset.operation o 
	on o.id = ece.operation_id 
join asset.operation_type ot 
	on o.operation_type_id = ot.id 
join datascience.dl_user_origination duo 
    on duo.nu_cnpj = o.client_id
join datascience.dl_partner           
    on dl_partner.ds_partner = duo.ds_origination_partner
where ece.status_id = &#39;1&#39;
    and (current_date - ece.date::date) &gt;= 90 
    [[and {{cost_center}}]]</pre>
</div></div></div></div><h2 id="IntegratedPartnership-TotalContractsNPL(Current)">Total Contracts NPL (Current)</h2><p>Trata-se da quantidade total de contratos em NPL (<a href="1903722523.html" data-linked-resource-id="1903722523" data-linked-resource-version="11" data-linked-resource-type="page">Non Performing Loan (NPL)</a>) .</p><div id="expander-1662065622" class="expand-container"><div id="expander-control-1662065622" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1662065622" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">select 
	count(distinct i.contract_number) as contracts
from asset.expected_cashflow_entry ece 
join asset.instrument i 
	on i.id = ece.instrument_id 
join asset.operation o 
	on o.id = ece.operation_id 
join asset.operation_type ot 
	on o.operation_type_id = ot.id 
join datascience.dl_user_origination duo 
    on duo.nu_cnpj = o.client_id
join datascience.dl_partner           
    on dl_partner.ds_partner = duo.ds_origination_partner
where ece.status_id = &#39;1&#39;
    and (current_date - ece.date::date) &gt;= 90 
    [[and {{cost_center}}]]</pre>
</div></div></div></div><h1 id="IntegratedPartnership-UpsellsxFirstDisbursement">Upsells x First Disbursement</h1><h2 id="IntegratedPartnership-FirstDisbursement">First Disbursement</h2><p>Trata-se da quantidade total de novos desembolsos (e que não são upsells) oriundos de parcerias.</p><div id="expander-1041827075" class="expand-container"><div id="expander-control-1041827075" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1041827075" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">with deals as (
	select 
		TO_TIMESTAMP(hed.create_date, &#39;YYYY-MM-DD HH24:MI:SS.US&#39;)::date create_date,
		TO_TIMESTAMP(hed.close_date , &#39;YYYY-MM-DD HH24:MI:SS.US&#39;)::date close_date,
		hed.origination_partner, 
		hubspot_id, 
		hed.cnpj, 
		-- transformar o campo stage_id de texto para inteiro 
		case 
			when deal_stage_id = &#39;&#39; then null 
				else deal_stage_id::int
		end as deal_stage_id, 
		dl_partner.ds_cost_center, 
		dl_partner.ds_partner
	from datascience.hubspot_export hed 
	join datascience.dl_partner
		on dl_partner.ds_partner = hed.origination_partner 
	where 1 = 1
	    [[and {{ds_cost_center}}]]
	    [[and {{partner}}]]
) 
, deal_disbursement as (
	select
		row_number() over(partition by i.id order by (loan_date - create_date) asc) as rn, 
		loan_date - create_date as lead_time, 
		o.client_id,
		deals.hubspot_id, 
		i.id as instrument_id,
		o.operation_code,
		i.contract_number,
--		case 
--			when substring(operation_code, LENGTH(operation_code) - 1) not like &#39;\d&#39; 
--			then contract_number
--			else null 
--		end as first_disbursement,
		case 
			when substring(operation_code, LENGTH(operation_code) - 1) ~ &#39;\d&#39; 
			then true
			else false
		end as upsell,
		i.loan_date , deals.ds_partner , c.created_at  
	from asset.instrument i
	left join asset.operation o 
		on i.operation_id = o.id 
	join asset.client c on o.client_id = c.cnpj 
	left join deals
		on o.client_id = deals.cnpj
		and i.loan_date &gt;= deals.create_date -- a linha de crédito só pode ter sido realizada após a entrada do deal
	join datascience.dl_partner
		on dl_partner.ds_partner = deals.ds_partner 
	where 1 = 1 
		[[and {{ds_cost_center}}]]
		[[and {{partner}}]]
		[[and loan_date between {{inicio}}and {{fim}}]]
	)
	select 
	    count(distinct dd.contract_number)
	from deal_disbursement dd
	where dd.upsell = false</pre>
</div></div></div></div><h2 id="IntegratedPartnership-GrossDisbursementFirstLoan">Gross Disbursement First Loan</h2><p>Trata-se da soma total do valor bruto (<a href="Desembolso-Bruto_1912537089.html" data-linked-resource-id="1912537089" data-linked-resource-version="8" data-linked-resource-type="page">Desembolso Bruto</a>) de novos desembolsos (e que não são upsell) oriundo de parceiras.</p><div id="expander-1467732462" class="expand-container"><div id="expander-control-1467732462" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1467732462" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">with disbursment_values as (	
	select 
		distinct i.id
			   , i.gross_amount
			   , i.liquid_amount 
			   , i.net_amount
			   , i.gross_amount - i.iof - i.fee_a55 - i.fee_issuer - i.&quot;fee_CETIP&quot; as calc_amount
			   , i.iof
			   , i.fee_a55  
			   , i.fee_issuer			  
			   , i.&quot;fee_CETIP&quot; as fee_CETIP
			   , case
			        when substring(operation_code, LENGTH(operation_code) - 1) ~ &#39;\d&#39;
			        then true
			        else false
			     end as upsell 
	from asset.instrument i
	join asset.operation o 
		on i.operation_id = o.id
	left join asset.realized_cashflow_entry rce
		on i.id = rce.instrument_id
	join asset.cashflow_type ct 
		on ct.id = rce.cashflow_type_id 
	left join asset.instrument_related irD
		on i.id = irD.destination_instrument
	left join datascience.dl_user_origination duo 
        on duo.nu_cnpj = o.client_id
    left join datascience.dl_partner           
        on dl_partner.ds_partner = duo.ds_origination_partner
	where 1=1	    
		and irD.origin_instrument is null -- retirando contratos renegociados 
		[[and i.loan_date between {{dt_inicio}} and {{dt_fim}}]]
		[[and {{cost_center}}]]
		[[and {{partner}}]]
)
select sum(gross_amount::float)/100
from disbursment_values 
where not upsell 
</pre>
</div></div></div></div><h2 id="IntegratedPartnership-Upsells">Upsells</h2><p>Trata-se da quantidade de novos desembolsos de clientes anteriores da a55 (definição de upsell), oriundos de parcerias.</p><div id="expander-678959762" class="expand-container"><div id="expander-control-678959762" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-678959762" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">with deals as (
	select 
		TO_TIMESTAMP(hed.create_date, &#39;YYYY-MM-DD HH24:MI:SS.US&#39;)::date create_date,
		TO_TIMESTAMP(hed.close_date , &#39;YYYY-MM-DD HH24:MI:SS.US&#39;)::date close_date,
		hed.origination_partner, 
		hubspot_id, 
		hed.cnpj, 
		-- transformar o campo stage_id de texto para inteiro 
		case 
			when deal_stage_id = &#39;&#39; then null 
				else deal_stage_id::int
		end as deal_stage_id, 
		dl_partner.ds_cost_center, 
		dl_partner.ds_partner
	from datascience.hubspot_export hed 
	join datascience.dl_partner
		on dl_partner.ds_partner = hed.origination_partner 
	where 1 = 1
	    [[and {{ds_cost_center}}]]
	    [[and {{partner}}]]
) 
, deal_disbursement as (
	select
		row_number() over(partition by i.id order by (loan_date - create_date) asc) as rn, 
		loan_date - create_date as lead_time, 
		o.client_id,
		deals.hubspot_id, 
		i.id as instrument_id,
		case 
			when substring(operation_code, LENGTH(operation_code) - 1) not like &#39;\d&#39; 
			then contract_number
			else null 
		end as first_disbursement,
		case 
			when substring(operation_code, LENGTH(operation_code) - 1) ~ &#39;\d&#39; 
			then contract_number
			else null
		end as upsell,
		i.loan_date , deals.ds_partner , c.created_at  
	from asset.instrument i
	left join asset.operation o 
		on i.operation_id = o.id 
	join asset.client c on o.client_id = c.cnpj 
	left join deals
		on o.client_id = deals.cnpj
		and i.loan_date &gt;= deals.create_date -- a linha de crédito só pode ter sido realizada após a entrada do deal
	join datascience.dl_partner
		on dl_partner.ds_partner = deals.ds_partner 
	where 1 = 1 
		[[and {{ds_cost_center}}]]
		[[and {{partner}}]]
		[[and loan_date between {{inicio}}and {{fim}}]]
	)
	select 
	    count(distinct upsell)
	from deal_disbursement</pre>
</div></div></div></div><h2 id="IntegratedPartnership-GrossDisbursementUpsell">Gross Disbursement Upsell</h2><p>Trata-se da soma do valor bruto (<a href="Desembolso-Bruto_1912537089.html" data-linked-resource-id="1912537089" data-linked-resource-version="8" data-linked-resource-type="page">Desembolso Bruto</a>) de novos desembolsos upsells oriundos de parcerias.</p><div id="expander-1232058132" class="expand-container"><div id="expander-control-1232058132" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1232058132" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">with disbursment_values as (	
	select 
		distinct i.id
			   , i.gross_amount
			   , i.liquid_amount 
			   , i.net_amount
			   , i.gross_amount - i.iof - i.fee_a55 - i.fee_issuer - i.&quot;fee_CETIP&quot; as calc_amount
			   , i.iof
			   , i.fee_a55  
			   , i.fee_issuer			  
			   , i.&quot;fee_CETIP&quot; as fee_CETIP
			   , case
			        when substring(operation_code, LENGTH(operation_code) - 1) ~ &#39;\d&#39;
			        then true
			        else false
			     end as upsell 
	from asset.instrument i
	join asset.operation o 
		on i.operation_id = o.id
	left join asset.realized_cashflow_entry rce
		on i.id = rce.instrument_id
	join asset.cashflow_type ct 
		on ct.id = rce.cashflow_type_id 
	left join asset.instrument_related irD
		on i.id = irD.destination_instrument
	left join datascience.dl_user_origination duo 
        on duo.nu_cnpj = o.client_id
    left join datascience.dl_partner           
        on dl_partner.ds_partner = duo.ds_origination_partner
	where 1=1	    
		and irD.origin_instrument is null -- retirando contratos renegociados 
		[[and i.loan_date between {{dt_inicio}} and {{dt_fim}}]]
		[[and {{cost_center}}]]
		[[and {{partner}}]]
)
select sum(gross_amount::float)/100
from disbursment_values 
where upsell 
</pre>
</div></div></div></div><h2 id="IntegratedPartnership-LeadTimePartnership">Lead Time Partnership</h2><p /><p>O lead time corresponde ao tempo médio entre a data de criação do do contrato e a data efetiva de desembolso.</p><p>Para cada contrato, o lead time (em dias) é calculado como:</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/1921548526/1923153921.png" data-image-src="attachments/1921548526/1923153921.png" data-height="13" data-width="335" data-unresolved-comment-count="0" data-linked-resource-id="1923153921" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20220330-134550.png" data-base-url="https://a55tech.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1921548526" data-linked-resource-container-version="16" data-media-id="ab8a21da-6df5-4f88-9cd1-193847336f0d" data-media-type="file"></span><p /><p>Para todos os contratos oriundos de parcerias, o lead time é dado como:</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/1921548526/1923088391.png" data-image-src="attachments/1921548526/1923088391.png" data-height="41" data-width="281" data-unresolved-comment-count="0" data-linked-resource-id="1923088391" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20220330-134514.png" data-base-url="https://a55tech.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1921548526" data-linked-resource-container-version="16" data-media-id="2aad2bd8-1ca9-425e-a8bc-29ed1f8d1153" data-media-type="file"></span><p>Quanto menor o lead time, mais rápido é o fluxo do cliente dentro da a55 até ele receber o seu desembolso.</p><div id="expander-1898169213" class="expand-container"><div id="expander-control-1898169213" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">SQL</span></div><div id="expander-content-1898169213" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">with base_datas_hubspot as (
	select 
		TO_TIMESTAMP(hed.create_date, &#39;YYYY-MM-DD HH24:MI:SS.US&#39;)::date create_date,
		TO_TIMESTAMP(hed.close_date , &#39;YYYY-MM-DD HH24:MI:SS.US&#39;)::date close_date,
		hed.origination_partner, 
		hubspot_id, 
		hed.cnpj, 
		deal_stage_id, 
		dl_partner.ds_cost_center, 
		dl_partner.ds_partner
	from datascience.hubspot_export hed 
	left join datascience.dl_partner
		on dl_partner.ds_partner = hed.origination_partner 
	where 1 = 1--origination_partner in (&#39;Pagolivre&#39;, &#39;Galaxpay&#39;)
		and (close_date is not null and close_date != &#39;&#39;)
		and deal_stage_id != &#39;122&#39;		-- stage 122 = &#39;[INT] Lost&#39;
		[[and {{cost_center}}]]
		[[and {{partner}}]]
		[[and TO_TIMESTAMP(hed.create_date, &#39;YYYY-MM-DD HH24:MI:SS.US&#39;)::date between {{inicio}} and {{fim}}]]
) 
, desembolsos as (
	select 
		o.client_id, 
		i.id as instrument_id,
		i.contract_number,
		i.loan_date 
	from asset.instrument i 
	left join asset.operation o 	
		on o.id = i.operation_id 
--	where client_id = &#39;40541760000120&#39;
)
, lead_time as (
	select
		row_number() over(partition by hubspot_id order by (loan_date - create_date) asc) as rn, 
		loan_date - create_date as lead_time, 
		* 
	from base_datas_hubspot
	join desembolsos 
		on desembolsos.client_id = base_datas_hubspot.cnpj
		and loan_date &gt;= create_date -- a linha de crédito só pode ter sido realizada após a entrada do deal	
)-- select * from lead_time where rn = 1
select
	sum(lead_time)/count(lead_time) as avarge_lead_time
from lead_time 
where rn = 1</pre>
</div></div></div></div>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1921548526/1921450021.png">image-20220329-215835.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1921548526/1921613848.png">image-20220329-221047.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1921548526/1922564152.png">image-20220329-221450.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1921548526/1923088385.png">image-20220330-134349.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1921548526/1923088391.png">image-20220330-134514.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1921548526/1923153921.png">image-20220330-134550.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1921548526/1922596908.png">image-20220330-143402.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Dec 29, 2022 17:45</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
